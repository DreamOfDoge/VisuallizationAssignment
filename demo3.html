<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>宇宙生命文明模拟</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: #000; 
            color: #fff;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }
        .container {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 8px;
            min-width: 300px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }
        button {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #34495e;
        }
        .stats {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            width: calc(1000px + 300px + 20px);
        }
        .stat-row {
            display: flex;
            justify-content: space-between;
            margin: 5px 0;
        }
        canvas {
            border: 1px solid #333;
            background: #0a0a0a;
        }
        .legend {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        .legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .color-box {
            width: 15px;
            height: 15px;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <h1>宇宙生命文明模拟 (1000x1000)</h1>
    <div class="container">
        <div class="controls">
            <div class="control-group">
                <h3>模拟控制</h3>
                <button id="startBtn">开始模拟</button>
                <button id="pauseBtn">暂停</button>
                <button id="resetBtn">重置宇宙</button>
            </div>
            <div class="control-group">
                <label>当前宇宙时间: <span id="timeDisplay">0 万年</span></label>
                <label>文明总数: <span id="civilizationCount">0</span></label>
                <label>资源耗尽文明数: <span id="resourceDepletedCount">0</span></label>
            </div>
            <div class="control-group">
                <h4>文明等级分布</h4>
                <label>演化阶段(1): <span id="level1Count">0</span></label>
                <label>初级阶段(2): <span id="level2Count">0</span></label>
                <label>一级阶段(3): <span id="level3Count">0</span></label>
                <label>二级阶段(4): <span id="level4Count">0</span></label>
                <label>三级阶段(5): <span id="level5Count">0</span></label>
            </div>
        </div>
        <div>
            <canvas id="universeCanvas" width="1000" height="1000"></canvas>
            <div class="legend">
                <div class="legend-item">
                    <div class="color-box" style="background: #333;"></div>
                    <span>无生命物质</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #2ecc71;"></div>
                    <span>演化阶段(1)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #3498db;"></div>
                    <span>初级阶段(2)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #9b59b6;"></div>
                    <span>一级阶段(3)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #f1c40f;"></div>
                    <span>二级阶段(4)</span>
                </div>
                <div class="legend-item">
                    <div class="color-box" style="background: #e74c3c;"></div>
                    <span>三级阶段(5)</span>
                </div>
            </div>
        </div>
    </div>
    <div class="stats">
        <div class="stat-row">
            <span>已发生文明吞并事件:</span>
            <span id="annexCount">0</span>
        </div>
        <div class="stat-row">
            <span>已发生文明战争事件:</span>
            <span id="warCount">0</span>
        </div>
        <div class="stat-row">
            <span>已发生文明消亡事件:</span>
            <span id="extinctionCount">0</span>
        </div>
        <div class="stat-row">
            <span>已发生星际灾害事件:</span>
            <span id="disasterCount">0</span>
        </div>
        <div class="stat-row">
            <span>已发生殖民事件:</span>
            <span id="colonizationCount">0</span>
        </div>
        <div class="stat-row">
            <span>已发生资源迁移战争:</span>
            <span id="resourceWarCount">0</span>
        </div>
    </div>

    <script>
        // 配置参数（核心优化：降低消耗、放缓增长、提高初始人口）
        const CONFIG = {
            UNIVERSE_SIZE: 1000,          // 宇宙棋盘尺寸
            SIMULATION_INTERVAL: 100,    // 模拟间隔(ms) = 100万年
            MAX_UNIVERSE_AGE: 300000,     // 宇宙最大年龄(万年) = 10亿年
            MATTER_DENSITY: 0.7,          // 初始物质密度
            // 概率参数 (万分之一为单位)
            PROB: {
                CIVILIZATION_SPAWN: 0.01,// 物质产生文明的概率（演化阶段）
                LEVEL_UP: {
                    1: 50,   // 演化→初级 (0.005%)
                    2: 2000, // 初级→一级 (0.2%)
                    3: 1000, // 一级→二级 (0.1%)
                    4: 2000  // 二级→三级 (0.2%)
                },
                SELF_EXTINCTION: {
                    1: 0.01,  // 演化阶段消亡
                    2: 10,   // 初级阶段自我消亡
                    3: 20   // 一级阶段自我消亡
                },
                DISASTER: {
                    OCCUR: 0.5,           // 星际灾害发生概率
                    EXTINCTION: {
                        1: 0.5, 2: 0.4, 3: 0.3, 4: 0.1, 5: 0 // 不同等级灾害消亡概率
                    },
                    REGRESS: {
                        1: 0.5, 2: 0.6, 3: 0.7, 4: 0.9, 5: 0 // 不同等级灾害倒退概率
                    }
                },
                DETECTION: {
                    1: 0,     // 演化阶段无观测能力
                    2: 1,   // 初级阶段(范围10)
                    3: 10,   // 一级阶段(范围100)
                    4: 20,   // 二级阶段(范围200)
                    5: 30    // 三级阶段(范围300)
                },
                HOSTILITY: {
                    BASE: 0.5,            // 基础敌对性(0-1)
                    WAR_THRESHOLD: 0.5,   // 战争触发阈值
                    WAR_ANNEX: 0.8        // 战争中高级文明吞并低级概率
                },
                COLONIZATION: {
                    BASE: 2.0,            // 基础殖民概率(万分之一)
                    SUCCESS: 0.8          // 殖民成功概率
                },
                SAME_LEVEL_WAR: {
                    WIN: 0.5,             // 胜率
                    EXTINCTION: 0.3       // 败者消亡概率
                }
            },
            // 观测范围 (像素)
            OBSERVATION_RANGE: {
                1: 0,
                2: 3,
                3: 10,
                4: 15,
                5: 20
            },
            // 资源消耗参数（核心优化：大幅降低消耗）
            RESOURCE: {
                CONSUMPTION_RATE: 0.1,  // 每100万年人均消耗资源（从0.01→0.001）
                INIT_MIN: 5,             // 初始资源最小值（从10→50）
                INIT_MAX: 15             // 初始资源最大值（从100→200）
            },
            // 人口参数（核心优化：调整初始/增长）
            POPULATION: {
                INIT: 5,                  // 文明初始人口（从10→5）
                MAX: 100,                 // 人口上限
                GROWTH_RATE: 0.01         // 每100万年人口增长率(从5%→1%)
            },
            // 殖民意愿参数
            COLONIZATION_WILL: {
                MIN: 0.2,                 // 最小殖民意愿
                MAX: 1.0                  // 最大殖民意愿
            }
        };

        // 颜色映射
        const COLOR_MAP = {
            0: '#333',    // 无生命物质
            1: '#2ecc71', // 演化阶段
            2: '#3498db', // 初级阶段
            3: '#9b59b6', // 一级阶段
            4: '#f1c40f', // 二级阶段
            5: '#e74c3c'  // 三级阶段
        };

        // 宇宙状态
        let universe = {
            grid: [],                // 1000x1000网格
            age: 0,                  // 当前年龄(万年)
            isRunning: false,        // 模拟状态
            intervalId: null,        // 定时器ID
            stats: {
                civilizations: 0,
                level1: 0,
                level2: 0,
                level3: 0,
                level4: 0,
                level5: 0,
                annexCount: 0,//吞并
                warCount: 0,
                extinctionCount: 0,
                disasterCount: 0,
                colonizationCount: 0,
                resourceDepletedCount: 0,
                resourceWarCount: 0
            }
        };

        // 获取Canvas上下文
        const canvas = document.getElementById('universeCanvas');
        const ctx = canvas.getContext('2d');

        // 初始化宇宙网格
        function initUniverse() {
            universe.grid = [];
            universe.age = 0;
            universe.stats = {
                civilizations: 0,
                level1: 0,
                level2: 0,
                level3: 0,
                level4: 0,
                level5: 0,
                annexCount: 0,
                warCount: 0,
                extinctionCount: 0,
                disasterCount: 0,
                colonizationCount: 0,
                resourceDepletedCount: 0,
                resourceWarCount: 0
            };

            // 创建1000x1000网格
            for (let y = 0; y < CONFIG.UNIVERSE_SIZE; y++) {
                const row = [];
                for (let x = 0; x < CONFIG.UNIVERSE_SIZE; x++) {
                    // 随机生成物质 (0=无物质, 1=有物质无生命, >1=有文明)
                    const hasMatter = Math.random() < CONFIG.MATTER_DENSITY;
                    // 随机生成初始资源 (50-200)
                    const resource = hasMatter ? 
                        Math.floor(Math.random() * (CONFIG.RESOURCE.INIT_MAX - CONFIG.RESOURCE.INIT_MIN + 1)) + CONFIG.RESOURCE.INIT_MIN : 0;
                    
                    row.push({
                        hasMatter: hasMatter,
                        civilizationLevel: 0,  // 0=无生命
                        hostility: 0,          // 敌对性(0-1)
                        population: 0,         // 文明人口(正整数)
                        resource: resource,    // 资源(0-200)
                        colonizationWill: 0,   // 殖民意愿(0-1)
                        lastUpdated: 0
                    });
                }
                universe.grid.push(row);
            }

            // 清空画布
            ctx.fillStyle = '#0a0a0a';
            ctx.fillRect(0, 0, CONFIG.UNIVERSE_SIZE, CONFIG.UNIVERSE_SIZE);
            
            // 绘制初始物质
            for (let y = 0; y < CONFIG.UNIVERSE_SIZE; y++) {
                for (let x = 0; x < CONFIG.UNIVERSE_SIZE; x++) {
                    if (universe.grid[y][x].hasMatter) {
                        ctx.fillStyle = COLOR_MAP[0];
                        ctx.fillRect(x, y, 1, 1);
                    }
                }
            }

            updateStatsDisplay();
        }

        // 更新统计显示
        function updateStatsDisplay() {
            document.getElementById('timeDisplay').textContent = `${universe.age} 万年`;
            document.getElementById('civilizationCount').textContent = universe.stats.civilizations;
            document.getElementById('level1Count').textContent = universe.stats.level1;
            document.getElementById('level2Count').textContent = universe.stats.level2;
            document.getElementById('level3Count').textContent = universe.stats.level3;
            document.getElementById('level4Count').textContent = universe.stats.level4;
            document.getElementById('level5Count').textContent = universe.stats.level5;
            document.getElementById('annexCount').textContent = universe.stats.annexCount;
            document.getElementById('warCount').textContent = universe.stats.warCount;
            document.getElementById('extinctionCount').textContent = universe.stats.extinctionCount;
            document.getElementById('disasterCount').textContent = universe.stats.disasterCount;
            document.getElementById('colonizationCount').textContent = universe.stats.colonizationCount;
            document.getElementById('resourceDepletedCount').textContent = universe.stats.resourceDepletedCount;
            document.getElementById('resourceWarCount').textContent = universe.stats.resourceWarCount;
        }

        // 随机概率判定
        function probabilityCheck(probability) {
            // probability: 万分之一为单位 (0.1 = 0.00001%)
            return Math.random() < (probability / 10000);
        }

        // 文明升级判定
        function checkLevelUp(cell) {
            if (cell.civilizationLevel >= 5) return;
            
            const levelUpProb = CONFIG.PROB.LEVEL_UP[cell.civilizationLevel];
            if (probabilityCheck(levelUpProb)) {
                // 更新统计
                universe.stats[`level${cell.civilizationLevel}`]--;
                cell.civilizationLevel++;
                universe.stats[`level${cell.civilizationLevel}`]++;
                
                // 升级时更新属性
                cell.hostility = Math.random();
                // 一级及以上文明生成殖民意愿
                if (cell.civilizationLevel >= 3) {
                    cell.colonizationWill = Math.random() * (CONFIG.COLONIZATION_WILL.MAX - CONFIG.COLONIZATION_WILL.MIN) + CONFIG.COLONIZATION_WILL.MIN;
                }
                // 升级时人口增长（不超过上限）
                cell.population = Math.min(
                    Math.floor(cell.population * (1 + CONFIG.POPULATION.GROWTH_RATE)),
                    CONFIG.POPULATION.MAX
                );
                
                return true;
            }
            return false;
        }

        // 资源消耗计算（核心修改：1级不消耗，2-3级耗尽直接灭亡）
        function consumeResource(cell) {
            // 1级文明不消耗资源；0级/无人口跳过
            if (cell.civilizationLevel === 0 || cell.civilizationLevel === 1 || cell.population === 0) return false;
            
            // 仅2级及以上文明消耗资源
            const consumption = CONFIG.RESOURCE.CONSUMPTION_RATE * cell.population;
            cell.resource = Math.max(0, cell.resource - consumption);
            
            // 资源耗尽处理
            if (cell.resource <= 0 && cell.civilizationLevel >= 2) {
                universe.stats.resourceDepletedCount++;
                
                // 1/2/3级文明资源耗尽直接灭亡
                if (cell.civilizationLevel <= 3) {
                    universe.stats[`level${cell.civilizationLevel}`]--;
                    universe.stats.civilizations--;
                    universe.stats.extinctionCount++;
                    
                    cell.civilizationLevel = 0;
                    cell.population = 0;
                    cell.hostility = 0;
                    cell.colonizationWill = 0;
                    return false; // 标记为无需迁移
                }
                
                // 4/5级文明标记为需要迁移
                return true;
            }
            return false;
        }

        // 人口增长（优化：放缓增长，带上限）
        function growPopulation(cell) {
            if (cell.civilizationLevel === 0 || cell.population >= CONFIG.POPULATION.MAX) return;
            
            // 1级文明无资源消耗限制；2+级需资源充足
            if (cell.civilizationLevel === 1 || cell.resource > 0) {
                cell.population = Math.min(
                    Math.floor(cell.population * (1 + CONFIG.POPULATION.GROWTH_RATE)),
                    CONFIG.POPULATION.MAX
                );
            }
            
            // 初始文明设置人口
            if (cell.civilizationLevel > 0 && cell.population === 0) {
                cell.population = CONFIG.POPULATION.INIT;
            }
        }

        // 文明迁移（仅4/5级文明）
        function migrateCivilization(x, y, cell) {
            // 仅4/5级文明有迁移能力
            if (cell.civilizationLevel < 4 || cell.resource > 0) return;
            
            const range = CONFIG.OBSERVATION_RANGE[cell.civilizationLevel];
            const candidates = [];
            
            // 收集观测范围内有物质的单元格
            for (let dy = -range; dy <= range; dy++) {
                for (let dx = -range; dx <= range; dx++) {
                    if (dx === 0 && dy === 0) continue;
                    
                    const nx = x + dx;
                    const ny = y + dy;
                    if (nx < 0 || nx >= CONFIG.UNIVERSE_SIZE || ny < 0 || ny >= CONFIG.UNIVERSE_SIZE) continue;
                    
                    const target = universe.grid[ny][nx];
                    if (target.hasMatter && target.resource > 0) {
                        candidates.push({x: nx, y: ny, cell: target});
                    }
                }
            }
            
            if (candidates.length === 0) {
                // 无迁移目标 → 灭亡：保存原始等级扣减
                const originalLevel = cell.civilizationLevel;
                universe.stats[`level${originalLevel}`]--;
                if (universe.stats[`level${originalLevel}`] < 0) {
                    universe.stats[`level${originalLevel}`] = 0;
                }
                universe.stats.civilizations--;
                universe.stats.extinctionCount++;
                
                cell.civilizationLevel = 0;
                cell.population = 0;
                cell.hostility = 0;
                cell.colonizationWill = 0;
                ctx.fillStyle = COLOR_MAP[0];
                ctx.fillRect(x, y, 1, 1);
                return;
            }
            
            // 随机选择目标
            const target = candidates[Math.floor(Math.random() * candidates.length)];
            
            // 目标有其他文明 → 资源战争
            if (target.cell.civilizationLevel > 0) {
                universe.stats.resourceWarCount++;
                fightWar(cell, target.cell, x, y, target.x, target.y, true);
            } else {
                // 迁移到空的有物质单元格
                target.cell.civilizationLevel = cell.civilizationLevel;
                target.cell.population = Math.min(
                    Math.floor(cell.population * 0.5),
                    CONFIG.POPULATION.MAX
                ); // 迁移50%人口（不超上限）
                target.cell.hostility = cell.hostility;
                target.cell.colonizationWill = cell.colonizationWill;
                
                // 原单元格灭亡
                const originalLevel = cell.civilizationLevel;
                cell.civilizationLevel=0;
                cell.population=0;
                cell.hostility = 0;
                cell.colonizationWill=0;
                ctx.fillStyle = COLOR_MAP[0];
                ctx.fillRect(x, y, 1, 1);
                
                universe.stats[`level${originalLevel}`]--;
                if (universe.stats[`level${originalLevel}`] < 0) {
                    universe.stats[`level${originalLevel}`] = 0;
                }
                universe.stats.civilizations--;
                    
                
                // 更新目标单元格：避免重复计数（先检查目标等级）
                if (target.cell.civilizationLevel > 0) {
                    universe.stats[`level${target.cell.civilizationLevel}`]++;
                    universe.stats.civilizations++;
                }
                ctx.fillStyle = COLOR_MAP[target.cell.civilizationLevel];
                ctx.fillRect(target.x, target.y, 1, 1);
            }
        }

        // 文明战争逻辑
        function fightWar(attacker, defender, ax, ay, dx, dy, isResourceWar) {
            universe.stats.warCount++;
            
            // 等级比较
            if (attacker.civilizationLevel > defender.civilizationLevel) {
                // 高级文明必胜
                winWar(attacker, defender, ax, ay, dx, dy, isResourceWar);
            } else if (attacker.civilizationLevel < defender.civilizationLevel) {
                // 低级文明必败
                loseWar(attacker, defender, ax, ay, dx, dy, isResourceWar);
            } else {
                // 同级文明随机胜负
                if (Math.random() < CONFIG.PROB.SAME_LEVEL_WAR.WIN) {
                    // 进攻方胜
                    winWar(attacker, defender, ax, ay, dx, dy, isResourceWar);
                } else {
                    // 进攻方败
                    loseWar(attacker, defender, ax, ay, dx, dy, isResourceWar);
                }
            }
        }

        // 战争胜利逻辑
        function winWar(winner, loser, wx, wy, lx, ly, isResourceWar) {
            universe.stats.annexCount++;
            
            // 保存败者原始等级（关键：避免后续修改等级导致计数错误）
            const loserOriginalLevel = loser.civilizationLevel;
            
            // 资源战争败者必定灭亡
            if (isResourceWar || winner.civilizationLevel === 5) {
                // 彻底灭亡：基于原始等级扣减计数
                universe.stats[`level${loserOriginalLevel}`]--;
                // 计数边界检查：防止负数
                if (universe.stats[`level${loserOriginalLevel}`] < 0) {
                    universe.stats[`level${loserOriginalLevel}`] = 0;
                }
                universe.stats.civilizations--;
                universe.stats.extinctionCount++;
                
                loser.civilizationLevel = 0;
                loser.population = 0;
                loser.hostility = 0;
                loser.colonizationWill = 0;
                
                ctx.fillStyle = COLOR_MAP[0];
                ctx.fillRect(lx, ly, 1, 1);
                
                // 胜利者殖民
                winner.population = Math.min(
                    Math.floor(winner.population * 1.1),
                    CONFIG.POPULATION.MAX
                ); // 人口增长10%（不超上限）
                if (winner.civilizationLevel >= 4) {
                    colonizeCell(winner, lx, ly);
                }
            } else {
                // 非资源战争同化：基于原始等级扣减
                universe.stats[`level${loserOriginalLevel}`]--;
                if (universe.stats[`level${loserOriginalLevel}`] < 0) {
                    universe.stats[`level${loserOriginalLevel}`] = 0;
                }
                loser.civilizationLevel = winner.civilizationLevel;
                loser.population = Math.min(
                    Math.floor(loser.population * 0.5),
                    CONFIG.POPULATION.MAX
                );
                loser.hostility = winner.hostility;
                loser.colonizationWill = winner.colonizationWill;
                universe.stats[`level${winner.civilizationLevel}`]++;
                
                ctx.fillStyle = COLOR_MAP[winner.civilizationLevel];
                ctx.fillRect(lx, ly, 1, 1);
            }
        }

        // 战争失败逻辑
        function loseWar(loser, winner, lx, ly, wx, wy, isResourceWar) {
            // 资源战争败者必定灭亡
            if (isResourceWar) {
                universe.stats[`level${loser.civilizationLevel}`]--;
                universe.stats.civilizations--;
                universe.stats.extinctionCount++;
                
                loser.civilizationLevel = 0;
                loser.population = 0;
                loser.hostility = 0;
                loser.colonizationWill = 0;
                
                ctx.fillStyle = COLOR_MAP[0];
                ctx.fillRect(lx, ly, 1, 1);
            } else {
                // 非资源战争败者人口减少
                loser.population = Math.floor(loser.population * 0.5);
                if (loser.population === 0) {
                    universe.stats[`level${loser.civilizationLevel}`]--;
                    universe.stats.civilizations--;
                    universe.stats.extinctionCount++;
                    
                    loser.civilizationLevel = 0;
                    loser.hostility = 0;
                    loser.colonizationWill = 0;
                    
                    ctx.fillStyle = COLOR_MAP[0];
                    ctx.fillRect(lx, ly, 1, 1);
                }
            }
            
            // 胜利者人口增长（不超上限）
            winner.population = Math.min(
                Math.floor(winner.population * 1.1),
                CONFIG.POPULATION.MAX
            );
        }

        // 殖民逻辑（仅二级/三级文明）
        function colonizeCell(cell, tx, ty) {
            if (cell.civilizationLevel < 4) return;
            
            //如果选择殖民的地方，资源耗尽，没有物质，并且已有文明，放弃
            const target = universe.grid[ty][tx];
            if (!target.hasMatter || target.resource < 0 || target.civilizationLevel > 0) return;
            
            // 殖民概率 = 殖民意愿 * 基础殖民概率
            const colonizeProb = cell.colonizationWill * CONFIG.PROB.COLONIZATION.BASE;
            if (probabilityCheck(colonizeProb)) {
                universe.stats.colonizationCount++;
                
                // 建立殖民地（人口不超上限）
                target.civilizationLevel = cell.civilizationLevel;
                target.population = Math.min(
                    Math.floor(cell.population * 0.2),
                    CONFIG.POPULATION.MAX
                ); // 20%人口迁移
                //随机化敌对和殖民意愿
                target.hostility = Math.random();
                target.colonizationWill = Math.random() * (CONFIG.COLONIZATION_WILL.MAX - CONFIG.COLONIZATION_WILL.MIN) + CONFIG.COLONIZATION_WILL.MIN;
                
                universe.stats[`level${cell.civilizationLevel}`]++;
                universe.stats.civilizations++;
                
                ctx.fillStyle = COLOR_MAP[cell.civilizationLevel];
                ctx.fillRect(tx, ty, 1, 1);
            }
        }

        // 文明消亡/倒退判定
        function checkExtinctionOrRegress(cell, x, y) {
            // 自我消亡
            if (cell.civilizationLevel >= 1 && cell.civilizationLevel <= 3) {
                const extinctionProb = CONFIG.PROB.SELF_EXTINCTION[cell.civilizationLevel];
                if (probabilityCheck(extinctionProb)) {
                    universe.stats[`level${cell.civilizationLevel}`]--;
                    universe.stats.civilizations--;
                    universe.stats.extinctionCount++;
                    cell.civilizationLevel = 0;
                    cell.hostility = 0;
                    cell.population = 0;
                    cell.colonizationWill = 0;
                    // 更新画布
                    ctx.fillStyle = COLOR_MAP[0];
                    ctx.fillRect(x, y, 1, 1);
                    return;
                }
            }

            // 星际灾害
            if (probabilityCheck(CONFIG.PROB.DISASTER.OCCUR) && cell.civilizationLevel > 0) {
                universe.stats.disasterCount++;
                
                // 不同等级文明灾害抗性不同
                const extinctionProb = CONFIG.PROB.DISASTER.EXTINCTION[cell.civilizationLevel];
                const regressProb = CONFIG.PROB.DISASTER.REGRESS[cell.civilizationLevel];
                
                if (Math.random() < extinctionProb) {
                    // 灾害导致消亡
                    universe.stats[`level${cell.civilizationLevel}`]--;
                    universe.stats.civilizations--;
                    universe.stats.extinctionCount++;
                    cell.civilizationLevel = 0;
                    cell.hostility = 0;
                    cell.population = 0;
                    cell.colonizationWill = 0;
                    ctx.fillStyle = COLOR_MAP[0];
                    ctx.fillRect(x, y, 1, 1);
                } else if (Math.random() < regressProb && cell.civilizationLevel > 1) {
                    // 灾害导致倒退（二级以上抗性提升）
                    universe.stats[`level${cell.civilizationLevel}`]--;
                    cell.civilizationLevel--;
                    cell.population = Math.min(
                        Math.floor(cell.population * 0.7),
                        CONFIG.POPULATION.MAX
                    ); // 人口减少30%（不超上限）
                    universe.stats[`level${cell.civilizationLevel}`]++;
                    
                    ctx.fillStyle = COLOR_MAP[cell.civilizationLevel];
                    ctx.fillRect(x, y, 1, 1);
                }
            }
        }
        
        // 文明观测与交互
        function checkCivilizationInteraction(x, y, cell) {
            if (cell.civilizationLevel < 2) return; // 演化阶段无观测能力
            
            const range = CONFIG.OBSERVATION_RANGE[cell.civilizationLevel];
            const detectionProb = CONFIG.PROB.DETECTION[cell.civilizationLevel];
            
            // 遍历观测范围内的所有单元格
            for (let dy = -range; dy <= range; dy++) {
                for (let dx = -range; dx <= range; dx++) {
                    if (dx === 0 && dy === 0) continue; // 跳过自身
                    
                    const nx = x + dx;
                    const ny = y + dy;
                    
                    // 边界检查
                    if (nx < 0 || nx >= CONFIG.UNIVERSE_SIZE || ny < 0 || ny >= CONFIG.UNIVERSE_SIZE) continue;
                    
                    const neighbor = universe.grid[ny][nx];
                    if (!neighbor.hasMatter || neighbor.civilizationLevel === 0) {
                        // 二级/三级文明尝试殖民空的有物质单元格
                        if (cell.civilizationLevel >= 4 && neighbor.hasMatter) {
                            colonizeCell(cell, nx, ny);
                        }
                        continue;
                    }
                    
                    // if (neighbor.civilizationLevel === cell.civilizationLevel) continue; // 同等级文明不交互
                    
                    // 尝试发现对方文明
                    if (probabilityCheck(detectionProb)) {
                        // 文明相遇 - 判定和平/战争
                        if(cell.hostility > CONFIG.PROB.HOSTILITY.WAR_THRESHOLD){
                            fightWar(cell,neighbor,x,y,nx,ny,false);
                        }
                    }
                }
            }
        }

        // 单次模拟迭代 (100万年)
        function simulateStep() {
            if (universe.age >= CONFIG.MAX_UNIVERSE_AGE) {
                stopSimulation();
                alert('宇宙寿命已达10亿年，模拟结束！');
                return;
            }

            // 增加宇宙年龄
            universe.age += 100;
            
            // 遍历所有单元格进行判定（随机抽样10%）
            const sampleSize = 100000; 
            for (let i = 0; i < sampleSize; i++) {
                const x = Math.floor(Math.random() * CONFIG.UNIVERSE_SIZE);
                const y = Math.floor(Math.random() * CONFIG.UNIVERSE_SIZE);
                const cell = universe.grid[y][x];
                
                if (!cell.hasMatter) continue;
                
                // 1. 物质产生文明 (演化阶段)
                if (cell.civilizationLevel === 0) {
                    if (probabilityCheck(CONFIG.PROB.CIVILIZATION_SPAWN)) {
                        cell.civilizationLevel = 1;
                        cell.population = CONFIG.POPULATION.INIT; // 初始人口5
                        universe.stats.level1++;
                        universe.stats.civilizations++;
                        ctx.fillStyle = COLOR_MAP[1];
                        ctx.fillRect(x, y, 1, 1);
                    }
                } else {
                    // 2. 人口增长（1%增长率，带上限）
                    growPopulation(cell);
                    
                    // 3. 资源消耗（1级不消耗，2-3级耗尽直接灭亡）
                    const needMigrate = consumeResource(cell);
                    
                    // 4. 仅4/5级文明资源耗尽迁移
                    if (needMigrate) {
                        migrateCivilization(x, y, cell);
                        // 迁移后更新画布（若原单元格灭亡）
                        if (cell.civilizationLevel === 0) {
                            ctx.fillStyle = COLOR_MAP[0];
                            ctx.fillRect(x, y, 1, 1);
                        }
                    }
                    
                    // 5. 文明升级判定
                    const levelUp = checkLevelUp(cell);
                    if (levelUp) {
                        ctx.fillStyle = COLOR_MAP[cell.civilizationLevel];
                        ctx.fillRect(x, y, 1, 1);
                    }
                    
                    // 6. 文明消亡/倒退判定
                    checkExtinctionOrRegress(cell, x, y);
                    
                    // 7. 文明观测与交互
                    checkCivilizationInteraction(x, y, cell);
                }
            }

            // 更新统计显示
            updateStatsDisplay();
        }

        // 模拟控制函数
        function startSimulation() {
            if (universe.isRunning) return;
            universe.isRunning = true;
            universe.intervalId = setInterval(simulateStep, CONFIG.SIMULATION_INTERVAL);
            document.getElementById('startBtn').disabled = true;
            document.getElementById('pauseBtn').disabled = false;
        }

        function pauseSimulation() {
            if (!universe.isRunning) return;
            universe.isRunning = false;
            clearInterval(universe.intervalId);
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        function stopSimulation() {
            pauseSimulation();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
        }

        // 绑定事件
        document.getElementById('startBtn').addEventListener('click', startSimulation);
        document.getElementById('pauseBtn').addEventListener('click', pauseSimulation);
        document.getElementById('resetBtn').addEventListener('click', () => {
            stopSimulation();
            initUniverse();
        });

        // 初始化
        initUniverse();
        document.getElementById('pauseBtn').disabled = true;
    </script>
</body>
</html>